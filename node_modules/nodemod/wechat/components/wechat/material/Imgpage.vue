<template>
    <div i="img-page">
        <div class="left-grid pull-left">            
            <div class="div-upload" :id="container_id">
                <div class="pull-left mr20">全部图片</div>
                <el-date-picker
                    v-model="timerange"
                    type="daterange"
                    placeholder="选择日期范围">
                </el-date-picker> 
                <el-button class="btn-green" @click="getList(1)">搜索</el-button>
                <div class="pull-left div-progress" id="upload-progress">
                </div>
                <el-button class="pull-right btn-green btn-upload" :id="pickfiles_id">本地上传</el-button>
                <span class="pull-right">大小不超过5M，已开启图片水印</span>
            </div>

            <div class="div-opt" style="display: none;">
                <span class="sp-all mr50" @click="is_checkall = !is_checkall"><i class="check-all icon " :class="is_checkall ? 'ion-android-checkbox-outline' : 'ion-android-checkbox-outline-blank'"></i>全选</span>
                <!-- <el-button class="btn-create" :disabled="true">移动分组</el-button> -->
                <el-button class="btn-create" :disabled="true">删除</el-button>

            </div>
            <div class="div-grid-view">
                <div class="grid-item" v-for="(item, i) in lists">
                    <div class="body">
                        <div class="content" :style="{backgroundImage: 'url(' + item.path + ')'}"></div>
                    </div>
                    <p class="title"><i style="display:none;" class="check-item icon ion-android-checkbox-outline-blank"></i>{{item.media_id}}</p>
                    <div class="opr">
                        <!-- <el-tooltip class="item" effect="dark" content="编辑名称" placement="top-start">
                            <el-popover
                                ref="popover"
                                placement="bottom"
                                width="290"
                                trigger="click">
                                <div class="slot-edit-txt">
                                    <p>编辑名称</p>
                                    <p>
                                        <el-input></el-input>
                                    </p>
                                    <p>
                                        <el-button class="btn-green">确定</el-button>
                                        <el-button>取消</el-button>
                                    </p>
                                </div>
                                <i class="create icon ion-android-create" slot="reference"></i>
                            </el-popover>
                        </el-tooltip>
                        <i class="swap icon ion-arrow-swap"></i> -->
                        <el-tooltip class="item" effect="dark" content="删除" placement="top">
                            <el-popover
                                ref="popover"
                                placement="bottom"
                                width="290"
                                v-model="arrShow[i].isShow"
                                trigger="click">
                                <div class="slot-txt">
                                    <p>确定删除此素材吗？</p>
                                    <p>
                                        <el-button class="btn-green" @click="deleteImg(i)">确定</el-button>
                                        <el-button @click="cancelPopover(i)">取消</el-button>
                                    </p>
                                </div>
                                <i class="trash icon ion-ios-trash" slot="reference"></i>
                            </el-popover>
                        </el-tooltip>
                    </div>
                </div>
                <div class="pl20 pt50 pb20" v-if="lists.length <= 0">暂无数据</div>
            </div>
        </div>
        <div class="clearfix"></div>  
        <div class="page-wrap text-right pr25">
            <base-page
                :page="page"
                :lists="lists"
                :isCloseOneAutoGetData="false"
                :isMonitorHistoryState="false"
                v-on:getPageList="getPageList"
            ></base-page>
        </div>
    </div>

</template>
<script>
    import {baseUpload} from 'hanzi-vue-package';
    import {Input,Button,Dropdown,DropdownMenu,DropdownItem,Progress,Popover,Tooltip,DatePicker} from 'element-ui';
    tools.vue.use(Input);
    tools.vue.use(Button);
    tools.vue.use(Dropdown);
    tools.vue.use(DropdownMenu);
    tools.vue.use(DropdownItem);
    tools.vue.use(Progress);
    tools.vue.use(Popover);
    tools.vue.use(Tooltip);
    tools.vue.use(DatePicker);
    tools.vue.use(baseUpload);
    
    export default{
        data(){
            return {
                container_id: 'container' + this.getRandomNum(1, 10000000),
                pickfiles_id: 'pickfiles' + this.getRandomNum(1,10000000),
                is_checkall: false,
                progress:{
                    percentage: 100,
                    status: 'success'
                },
                newGroup: '',//创建分组
                newGroupVisible: true,
                timerange: [],
                lists : [
                ],
                page : {},
                arrShow: [],
            }
        },
        computed:{

        },
        methods: {
            getList: function(page, page_size){
                let that = this, ajaxData = {};
                ajaxData.page = page;
                if(that.timerange[0]){
                    ajaxData.begin_time = parseInt(that.timerange[0]/1000);
                    ajaxData.end_time = parseInt(that.timerange[1]/1000);
                }

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/medias',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.list){
                            that.lists = res.list.data;
                            that.page = res.list;
                            for(let i in that.lists){
                                that.lists[i].isShow = false;
                                that.arrShow.push({isShow: false});
                            }
                            //that.lists = Object.assign({}, that.lists);
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            /* 分页数据 */
            getPageList: function (page, page_size) {
                var that = this;
                that.getList(page, page_size)
            },
            cancelPopover: function(idx){
                let that = this;
                that.arrShow[idx].isShow = false;
            },
            deleteImg: function(i){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/medias/' + that.lists[i].id,
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        that.lists.splice(i, 1);
                        that.arrShow.splice(i, 1);

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'DELETE'
                });

            },
            handleIconClick(ev) {
              console.log(ev);
            },
            /* 生成随机数 */
            getRandomNum: function (s1,s2) {
                var Range = s2 - s1;
                var Rand = Math.random();
                return(s1 + Math.round(Rand * Range));
            },
            /* 跳转 */
            toUrl: function (url, val) {
                tools.router.push({path: url, query: val});
            }

        },
        components: {
        },
        filters:{

        },
        watch:{
            is_checkall: function(val){
                if(val){

                }
                else{

                }
            }

        },
        mounted(){
            let that = this;
            var uploads = new upload({
                container: that.container_id,     //容器ID
                browse_button: that.pickfiles_id, //按钮ID
                progress: 'upload-progress',        //进度条ID
                type: 'wechat_image',            //请求接口时的传参，upload_type:"headpic"
                setting : 'local',          //local：本地，cloud：云
                chunk_size : '200kb',       //分段传输的大小
                group: ['img'],             //上传格式组
                url: '/api/admin/upload',                   //上传路径
                callback: function (res) {
                    //that.img_url = res.data.url;
                    let ajaxData = {
                            media_id: res.data.upload_id,
                            type: 1
                        };
                    tools.ajax({
                        url: '/api/admin/wechat/medias',
                        ajaxData: ajaxData,
                        successFun: function (resx) {
                            tools.alert.closeLoading();
                            if(that.lists.length >= 15){
                                that.lists.splice(that.lists.length -1, 1);
                                that.arrShow.splice(that.arrShow.length -1, 1);
                            }
                            that.lists.unshift({
                                is_checked: false,
                                id: res.data,
                                path: res.data.url
                            });
                            that.arrShow.unshift({isShow: false});
                        },
                        errorFun: function (error_data, status, headers, error_obj) {
                            tools.alert.closeLoading();
                            tools.alert.error(error_data.error_msg);
                        },
                        type: 'POST'
                    });
                }
            });

        }
    }
</script>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";
    @import "../../../assets/sass/common/wechat_btn";
    [i="img-page"]{
        min-width: 900px;
        width: 100%;
        margin: 10px 15px;
        border: 1px solid #e7e7eb;
        height: 100%;
        /* overflow: auto; */

        .right-group{
            width: 158px;
            a{
                height: 32px;
                line-height: 32px;
                display: block;
                padding-left: 15px;
                color: #333;
                &.active{
                    background-color: #f4f5f9;
                }
                &:hover{
                    background-color: #f4f5f9;
                }
                .ion-plus{
                    margin-right: 5px;
                    color: #b2b2b2;
                }
            }
        }
        .left-grid{
            min-width: 900px;
            width: 100%;
            /* border-right: 1px solid #e7e7eb; */
        }
        .div-upload{
            padding: 10px 20px;
            height: 52px;
            line-height: 32px;
            .div-progress{
                display: none!important;
                min-width: 500px;
                max-width: 600px;
                .el-progress{
                    line-height: 32px;
                }
            }
            .btn-upload{
                border: none;
                background-color: #13ce66;
                color: #fff;
                margin-left: 5px;
                &:hover{
                    background-color: #2f9833;
                }
            }
        }
        .check-all,.check-item{
            width: 16px;
            height: 16px;
            font-size: 18px;
            margin-right: 5px;
            vertical-align: middle;


        }
        .div-opt{
            padding: 0 20px;
            height: 100%;
            overflow: auto;
            line-height: 52px;
            background-color: rgb(244, 245, 249);
            .sp-all{
                cursor: pointer;
            }
            .btn-create{
            }
            .btn-create-share{
                background-color: #44b549;
                vertical-align: top;
                cursor: pointer;
                @include rounded(4px);
                &:hover{
                    background-color: #2f9833;
                    @include rounded(4px);
                }
                .classify-title{
                        height: 34px;
                        width: 34px;
                        text-align: center;
                        display: block;
                    i{
                        color: #fff;
                        margin: 0 !important;
                        line-height: 34px;
                    }
                }

            }
            .i-rank{
                font-size: 24px;
                cursor: pointer;
                color: rgb(171, 172, 174);
                &.grid-rank{
                }
                &.active{
                    color: #000;
                }
            }            
        }
        .div-grid-view{

            .grid-item{
                width: 170px;
                height: 234px;
                border: 1px solid #e7e7eb;
                float: left;
                margin: 20px;
                .time{
                    height: 45px;
                    line-height: 45px;                    
                    margin: 0 20px;
                    border-bottom: 1px solid #e7e7eb;
                }
                .body{
                    position: relative;
                    cursor: pointer;
                    .content{
                        background-size: cover;
                        width: 100%;
                        height: 170px;
                        padding: 20px;
                    }
                }
                .title{
                    height: 32px;
                    line-height: 32px;
                    padding: 0 10px;
                    /* max-width: 150px; */
                    max-width: 168px;
                    position: relative;
                    cursor: pointer;
                    @include wordEllipsis();
                }
                .opr{
                    border-top: 1px solid #e7e7eb;
                    display: flex;
                    height: 30px;
                    line-height: 30px;

                    i{
                        text-align: center;
                        background-color: rgb(244, 244, 244);
                        cursor: pointer;
                        color: rgb(178, 178, 178);
                        flex-grow: 1;
                        align-items: stretch;
                        font-size: 24px;                        
                        border-right: 1px solid #e7e7eb;
                        &.create{}
                        &.trash{}
                        &:last-child{
                            border-right: none;
                        }
                        &:hover{
                            color: #000;
                        }
                    }

                    &>span{
                        text-align: center;
                        background-color: rgb(244, 244, 244);
                        cursor: pointer;
                        color: rgb(178, 178, 178);
                        flex-grow: 1;
                        align-items: stretch;
                        font-size: 24px;                        
                        border-right: 1px solid #e7e7eb;
                        &.create{}
                        &.trash{}
                        &:last-child{
                            border-right: none;
                        }
                        &:hover{
                            color: #000;
                        }
                    }
                }
            }
        }

    }

</style>
