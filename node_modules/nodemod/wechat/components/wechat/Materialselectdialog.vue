<template>
    <el-dialog
        :title="title"
        custom-class="material-select-dlg"
        :close-on-click-modal="false"
        :close-on-press-escape="false"
        :before-close="closeDlg"
        :visible.sync="dlgVisible">
        <div class="dlg-body">
            <div class="dlg-top">   
                <div class="pull-left">
                    <el-input
                      placeholder="标题"
                      icon="search"
                      v-model.trim="inputTxt"
                      :on-icon-click="getMaterial">
                    </el-input>
                </div>
                <div class="pull-right">
                    <!-- <el-button class="btn-green btn-autowidth" icon="plus">新建图文消息</el-button> -->
                </div>
            </div>
            <div class="dlg-items">
                <div class="grid-item" v-for="(img, i) in lists" @click="checkImg(i)">
                    <p class="time">更新于 {{img.updated_at | date}}</p>
                    <div class="body">
                        <div class="content">
                            <span>{{img.title}}</span>                            
                            <div class="bg" :style="{backgroundImage: 'url('+ img.cover +')'}"></div>
                            <span>{{img.desc}}</span>
                        </div>
                    </div>
                    <span class="bg-checked" v-if="img.is_checked">
                        <i class="icon ion-checkmark"></i>
                    </span>
                    <span class="bg-checked-hover" v-else>
                        <i class="icon ion-checkmark"></i>
                    </span>
                </div>                           
            </div>      
            <div class="page-wrap text-right pr25">
                <base-page
                    :page="page"
                    :lists="lists"
                    :isCloseOneAutoGetData="false"
                    :isMonitorHistoryState="false"
                    v-on:getPageList="getMaterial"
                ></base-page>
            </div>
        </div>
        <div slot="footer" class="dialog-footer text-center">
            <el-button class="mr30" @click="subImg" :disabled="!has_checked">确定</el-button>
            <el-button class="mr30" @click="closeDlg">取消</el-button>
        </div>
    </el-dialog>

</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../assets/tool";    
    @import "../../assets/sass/common/wechat_btn";
    .material-select-dlg{
        &.el-dialog{
            width: 960px!important;
            height: 627px!important;
        }
        .el-dialog__header{
            border-bottom: 1px solid #e7e7eb;
            height: 52px;
            background-color: rgb(244, 245, 249);
            .el-dialog__title{
                font-weight: normal;
            }
        }
        .el-dialog__body{
            padding: 0;
        }
        .el-dialog__footer{
            padding: 0;
            border-top: 1px solid #e7e7eb;
            text-align: left;
        }

        .dlg-body{
            height: 509px;
            /* padding: 30px 0 0 45px; */
            .dlg-top{
                height: 56px;
                line-height: 56px;
                padding: 0 20px;
                border-bottom: 1px solid #e7e7eb;
                .pull-left{
                    width: 350px;
                }
            }
            .dlg-items{
                height: 410px;
                padding: 28px 140px;
                overflow-y: auto;
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                width: 960px;
                .grid-item{
                    width: 316px;
                    height: 293px;
                    border: 1px solid #e7e7eb;
                    margin-bottom: 20px;
                    position: relative;
                    .time{
                        height: 45px;
                        line-height: 45px;                    
                        margin: 0 20px;
                        border-bottom: 1px solid #e7e7eb;
                    }
                    .body{
                        position: relative;
                        cursor: pointer;
                        .content{
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        padding: 20px;
                        padding-top: 10px;
                        span{
                            max-width: 100%;
                            display: inline-block;
                            height: 20px;
                        }
                        .bg{
                            width: 100%;
                            height: 188px;
                            background: no-repeat center center/cover;
                        }
                        }
                    }                        
                    .bg-checked{
                        position: absolute;
                        width: 316px;
                        height: 293px;
                        background-color: rgba(0,0,0,.5);
                        color: #fff;
                        line-height: 293px;
                        text-align: center;
                        top: 0;
                        left: 0;
                        i{
                            font-size: 64px;
                        }
                    }
                    .bg-checked-hover{
                        display: none;
                        position: absolute;
                        width: 316px;
                        height: 293px;
                        background-color: rgba(0,0,0,.5);
                        color: #fff;
                        line-height: 293px;
                        text-align: center;
                        top: 0;
                        left: 0;
                        i{
                            font-size: 64px;
                        }

                    }
                    &:hover .bg-checked-hover{
                        display: block;
                    }
                }
            }
        }
        .dialog-footer{
            padding: 0;
            line-height: 65px;
            background-color: #f4f5f9;
        }
    }
</style>
<script>
    import {basePage} from 'hanzi-vue-package';
    tools.vue.use(basePage);
    import {Dialog, Button, Input} from 'element-ui';
    tools.vue.use(Dialog);
    tools.vue.use(Button);
    tools.vue.use(Input);
    
    export default{
        data(){
            return {
                inputTxt: '',
                lists: [
                    /*{
                        name: '已开启图片水印启图片水印',
                        url: '/static/img/hanzi_logo_2.84dfb7c.png',
                        is_checked: false
                    }*/
                ],
                page : {},
                has_checked: false,
            }
        },
        props: ['dialogVisible','title'],
        methods: {
            getMaterial: function(page, page_size){
                let that = this, ajaxData = {};
                if(page){
                    ajaxData.page = page;
                }
                if(that.inputTxt){
                    ajaxData.title = that.inputTxt;
                }
                ajaxData.type = 1;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/newses',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.list){
                            that.lists = res.list.data;
                            that.page = res.list;
                            for(let i in that.lists){
                                that.lists[i].isShow = false;
                            }
                            that.lists = Object.assign({}, that.lists);
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            closeDlg() {
                this.$emit('closeDlg');
                this.clearData();
            },         
            checkImg: function(idx){
                let that = this;
                that.has_checked = false;
                if(that.lists[idx].is_checked){
                    that.lists[idx].is_checked = !that.lists[idx].is_checked;
                }
                else{
                    for(let i in that.lists){
                        that.lists[i].is_checked = false;
                    }
                    that.lists[idx].is_checked = true;
                    that.has_checked = true;
                }
            },
            subImg: function(){
                let that = this, tmpData = [];
                for(let i in that.lists){
                    if(that.lists[i].is_checked){
                        tmpData.push(that.lists[i]);
                    }
                }

                that.$emit('closeDlg', {img_arr: tmpData});
                that.clearData();
            },
            //清理数据
            clearData: function(){
                let that = this;
                that.lists = [];
                that.has_checked = false;
                that.upload_handler = null;
            },
            checkUpload: function(){
                let that = this;
            },
            /* 生成随机数 */
            getRandomNum: function (s1,s2) {
                var Range = s2 - s1;
                var Rand = Math.random();
                return(s1 + Math.round(Rand * Range));
            },

        },
        computed: {
            dlgVisible: function(){
                return this.dialogVisible;
            }
        },
        components: {
        },
        filters:{
            date: function (timestamp, format){
                //let f = 'Y-m-d H:i';
                let f = 'Y年m月d日';
                if(format){
                    f = format;
                }
                return tools.date(f, timestamp);
            },

        },
        watch:{
            dialogVisible: function(v){
                let that = this;
                if(v){                    
                    that.getMaterial();
                }

            }
        },
        created(){          
        },
        mounted(){
            let that = this;
            //that.dialogVisible = false;
            
        }
    }
</script>
