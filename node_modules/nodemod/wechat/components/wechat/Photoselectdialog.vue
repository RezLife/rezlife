<template>
    <el-dialog
        :title="title"
        custom-class="photo-select-dlg"
        :close-on-click-modal="false"
        :close-on-press-escape="false"
        :before-close="closeDlg"
        :visible.sync="dlgVisible">
        <div class="dlg-body">
            <!-- <div class="group-list pull-left">
                <a>全部图片<span>(148)</span></a>
                <a>未分组<span>(148)</span></a>
                <a>文章配图<span>(0)</span></a>
                <a><i class="icon ion-plus"></i>新建分组</a>
            </div> -->
            <div class="dlg-right pull-left">
                <div class="top-upload text-right" :id="container_id">
                    <div class="pull-left div-progress" id="upload-progress">
                    </div>
                    <span>已开启图片水印</span>
                    <el-button class="btn-green" :id="pickfiles_id">本地上传</el-button>
                </div>   

                <div class="photo-list">
                    <!-- <a class="item">
                        <span class="upload-progress"></span>
                        <span class="bg-img" :style=""></span>
                        <span class="title"></span>
                    </a> -->
                    <a class="item" v-for="(img, i) in lists" @click="checkImg(i)">
                        <span class="bg-img" :style="{backgroundImage : 'url('+ img.path +')'}"></span>
                        <!-- <span class="title">{{img.name}}</span> -->
                        <span class="bg-checked" v-if="img.is_checked">
                            <i class="icon ion-checkmark"></i>
                        </span>
                        <span class="bg-checked-hover" v-else>
                            <i class="icon ion-checkmark"></i>
                        </span>
                    </a>
                </div>
                <div class="photo-page">                     
                    <div class="page-wrap text-right pr40">
                        <base-page
                            :page="page"
                            :lists="lists"
                            :isCloseOneAutoGetData="false"
                            :isMonitorHistoryState="false"
                            v-on:getPageList="getPageList"
                        ></base-page>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <div slot="footer" class="dialog-footer text-center">
            <!-- <span class="pull-left static-text ml20">已选0个，可选100个</span> -->
            <el-button class="mr30" @click="subImg" :disabled="!has_checked">确 定</el-button>
            <el-button @click="closeDlg">取 消</el-button>
        </div>
    </el-dialog>

</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../assets/tool";    
    @import "../../assets/sass/common/wechat_btn";
    .photo-select-dlg{
        &.el-dialog{
            width: 696px!important;
            height: 580px!important;

        }
        .el-dialog__header{
            border-bottom: 1px solid #e7e7eb;
            height: 52px;
            background-color: rgb(244, 245, 249);
            .el-dialog__title{
                font-weight: normal;
            }
        }
        .el-dialog__body{
            padding: 0;
        }
        .el-dialog__footer{
            padding: 0;
            border-top: 1px solid #e7e7eb;
            text-align: left;
        }

        .dlg-body{
            .group-list{
                height: 462px;
                width: 150px;
                display: inline-block;
                a{
                    color: #222;
                    display: block;
                    height: 32px;
                    line-height: 32px;
                    padding-left: 20px;
                    span{
                        color: #8d8d8d;
                    }
                    i{
                        color: #8d8d8d;
                        font-size: 16px;
                    }
                    &:hover{
                        background-color: #e7e7eb;
                    }
                    &:active{
                        background-color: #e7e7eb;
                    }
                }
            }
            .dlg-right{
                display: inline-block;
                height: 462px;
                width: 696px;
                border-left: 1px solid #e7e7eb;
                .top-upload{
                    padding: 10px 20px;
                    border-bottom: 1px solid #e7e7eb;
                    button{
                        margin-left: 10px;
                    }
                    .div-progress{
                        display: none!important;
                    }
                }
                .photo-list{
                    padding: 20px 20px 5px;
                    height: 340px;
                    overflow-y: auto;
                    .item{
                        display: inline-block;
                        position: relative;
                        border: 1px solid #e7e7eb;
                        margin-right: 10px;
                        margin-bottom: 10px;
                        span{
                            display: block;
                        }
                        .bg-img{
                            /* width: 117px;
                            height: 117px; */
                            width: 117px;
                            height: 149px;
                            background-size: cover;
                            background-position: center center;
                        }
                        .title{
                            display: none;
                            height: 32px;
                            line-height: 32px;
                            @include wordEllipsis();
                            color: #222;
                            padding: 0 10px;
                            max-width: 115px;
                        }
                        .bg-checked{
                            position: absolute;
                            /* width: 117px;
                            height: 117px; */
                            width: 117px;
                            height: 149px;
                            background-color: rgba(0,0,0,.5);
                            color: #fff;
                            line-height: 149px;
                            text-align: center;
                            top: 0;
                            left: 0;
                            i{
                                font-size: 64px;
                            }
                        }
                        .bg-checked-hover{
                            display: none;
                            position: absolute;
                            /* width: 117px;
                            height: 117px; */
                            width: 117px;
                            height: 149px;
                            background-color: rgba(0,0,0,.5);
                            color: #fff;
                            line-height: 149px;
                            text-align: center;
                            top: 0;
                            left: 0;
                            i{
                                font-size: 64px;
                            }

                        }
                        &:hover .bg-checked-hover{
                            display: block;
                        }

                    }
                }

            }

        }
        .dialog-footer{
            padding: 0;
            line-height: 65px;
            background-color: #f4f5f9;
            .static-text{
                margin-right: 150px;
            }
        }
    }
</style>
<script>
    import {basePage,Upload} from 'hanzi-vue-package';
    import {Dialog, Button} from 'element-ui';
    tools.vue.use(Dialog);
    tools.vue.use(Button);
    tools.vue.use(Upload);
    tools.vue.use(basePage);
    
    export default{
        data(){
            return {
                container_id: 'container' + this.getRandomNum(1, 10000000),
                pickfiles_id: 'pickfiles' + this.getRandomNum(1,10000000),
                lists: [
                    /*{
                        name: '已开启图片水印启图片水印',
                        url: '/static/img/hanzi_logo_2.84dfb7c.png',
                        is_checked: false
                    }*/
                ],
                page : {},
                has_checked: false,
                upload_handler: null,
                firstOpen: false,
            }
        },
        props: ['dialogVisible','title'],
        methods: {
            getList: function(page, page_size){
                let that = this, ajaxData = {};
                ajaxData.page = page;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/medias',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.list){
                            that.lists = res.list.data;
                            that.page = res.list;
                            for(let i in that.lists){
                                that.lists[i].isShow = false;
                                //that.arrShow.push({isShow: false});
                            }
                            //that.lists = Object.assign({}, that.lists);
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            /* 分页数据 */
            getPageList: function (page, page_size) {
                var that = this;
                that.getList(page, page_size)
            },
            closeDlg() {
                this.$emit('closeDlg');
                this.clearData();
            },
            /*checkImg: function(idx){
                let that = this;
                that.img_data[idx].is_checked = !that.img_data[idx].is_checked;
                that.has_checked = false;
                for(let i in that.img_data){
                    if(that.img_data[i].is_checked){
                        that.has_checked = true;
                        break;
                    }
                }
            },  */          
            checkImg: function(idx){
                let that = this;
                that.has_checked = false;
                if(that.lists[idx].is_checked){
                    that.lists[idx].is_checked = !that.lists[idx].is_checked;
                }
                else{
                    for(let i in that.lists){
                        that.lists[i].is_checked = false;
                    }
                    that.lists[idx].is_checked = true;
                    that.has_checked = true;
                }
            },
            subImg: function(){
                let that = this, tmpData = [];
                for(let i in that.lists){
                    if(that.lists[i].is_checked){
                        tmpData.push(that.lists[i]);
                    }
                }

                that.$emit('closeDlg', {img_arr: tmpData});
                that.clearData();
            },
            //清理数据
            clearData: function(){
                let that = this;
                that.lists = [];
                that.has_checked = false;
                that.upload_handler = null;
            },
            checkUpload: function(){
                let that = this;
            },
            /* 生成随机数 */
            getRandomNum: function (s1,s2) {
                var Range = s2 - s1;
                var Rand = Math.random();
                return(s1 + Math.round(Rand * Range));
            },

        },
        computed: {
            dlgVisible: function(){
                return this.dialogVisible;
            }
        },
        components: {
        },
        filters:{

        },
        watch:{
            dialogVisible: function(v){
                let that = this;
                if(v && that.firstOpen === false){
                    that.firstOpen = true;
                    setTimeout(function() {
                        that.upload_handler = new upload({
                            container: that.container_id,     //容器ID
                            browse_button: that.pickfiles_id, //按钮ID
                            progress: 'upload-progress',        //进度条ID
                            type: 'wechat_image',            //请求接口时的传参，upload_type:"headpic"
                            setting : 'local',          //local：本地，cloud：云
                            chunk_size : '200kb',       //分段传输的大小
                            group: ['img'],             //上传格式组
                            url: '/api/admin/upload',                   //上传路径
                            callback: function (res) {
                                //that.img_url = res.data.url;
                                let ajaxData = {
                                        media_id: res.data.upload_id,
                                        type: 1
                                    };
                                tools.ajax({
                                    url: '/api/admin/wechat/medias',
                                    ajaxData: ajaxData,
                                    successFun: function (resx) {
                                        tools.alert.closeLoading();           
                                        if(that.lists.length >= 15){
                                            that.lists.splice(that.lists.length -1, 1);
                                        }
                                        that.lists.unshift({
                                            is_checked: false,
                                            id: resx.data,
                                            path: res.data.url
                                        });

                                    },
                                    errorFun: function (error_data, status, headers, error_obj) {
                                        tools.alert.closeLoading();
                                        tools.alert.error(error_data.error_msg);
                                    },
                                    type: 'POST'
                                });
                            }
                        });
                    },0)
                    
                }
                else if(v){                    
                    that.getList();
                }

            }
        },
        created(){          
        },
        mounted(){
            let that = this;
            //that.dialogVisible = false;
            
        }
    }
</script>
