<template>
    <div i="wechat-autoreply-keywords">
        <div class="add">
            <el-button class="btn-green" @click="is_new = !is_new;form.editing = true"><i class="icon ion-plus"></i>添加规则</el-button>
        </div>
        <div class="new rule-item mt20" v-show="is_new">
            <div class="rule-item-top">
                新规则
                <a class="pull-right" @click="form.editing = !form.editing"><i class="icon ion-arrow-down-b"></i></a>
            </div>
            <div class="edit-item" v-if="form.editing">
                <div class="item rule-name-area">
                    <label class="rule-label rule-name">规则名</label>
                    <el-input v-model.trim="form.rule_title" :maxlength="60"></el-input>
                    <p class="edit-tips">规则名最多60个字</p>
                </div>
                <div class="item">
                    <label class="rule-label rule-kw">关键字</label>
                    <a class="pull-right add-kw" @click="openKwDlg(-1)">添加关键字</a>
                    <div class="kw-list">
                        <div class="kw-item" v-for="(kw, k) in form.keyword">
                            <span>{{kw.keyword}}</span>
                            <div class="pull-right text-right opr">
                                <a>已全匹配</a>
                                <a class="edit" @click="openKwDlg(-1, k)"><i class="icon ion-android-create"></i></a>
                                <a class="delete" @click="deleteKeyword(form.keyword, k)"><i class="icon ion-ios-trash"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="item">
                    <label class="rule-label rule-reply">回复</label>
                    <div class="pull-right text-right opr">
                        <el-checkbox  :checked="true" :disabled="true">回复全部</el-checkbox>
                    </div>                    
                </div>
                <div class="item">
                    <ul class="toolbar">                        
                        <li @click="openTextDlg(-1)"><i class="menu-con text"></i></li>
                        <li @click="photo_idx=-1;dlgPhotoVisible=true;"><i class="menu-con img"></i></li>
                        <li><i class="menu-con voice"></i></li>
                        <li><i class="menu-con video"></i></li>
                        <li @click="material_idx=-1;dlgMaterialVisible=true;"><i class="menu-con appmsg"></i></li>
                    </ul> 
                    <div class="edit-content">
                        <template v-for="(rsp, r) in form.response">
                            <div class="con-item" v-if="rsp.type == 1">
                                <span>{{rsp.text}}</span>
                                <div class="pull-right text-right opr">
                                    <a class="edit" @click="openTextDlg(-1, r)"><i class="icon ion-android-create"></i></a>
                                    <a class="delete" @click="deleteResponse(form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div>
                            </div>
                            <div class="con-item" v-else-if="rsp.type == 2">
                                <div class="con-appmsg pull-left">
                                    <a>
                                        <span class="bg" :style="{backgroundImage: 'url('+ rsp.img_url +')'}"></span>
                                        <span class="title pull-left">
                                        [图片]</span>
                                        <div class="clearfix"></div>
                                    </a>
                                </div>
                                <div class="pull-right text-right opr">
                                    <a class="delete" @click="deleteResponse(form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div>   
                                <div class="clearfix"></div> 
                            </div>
                            <div class="con-item" v-else-if="rsp.type == 3">
                                <div v-show="rsp.value.length > 0" 
                                     v-for="(appmsg, v) in rsp.value"
                                    class="news-item" :style="{backgroundImage: 'url('+ appmsg.cover +')'}">
                                    <span>{{appmsg.title}}</span>
                                    <div class="cover-del" @click="deleteMaterial(rsp.value, v)"><i class="icon ion-ios-trash"></i></div>
                                </div>
                                <a class="select-outer" @click="material_idx=-1;dlgMaterialVisible=true;material_rsp_idx=r;" v-show="rsp.value.length < 8">
                                    <i class="icon ion-ios-plus-empty"></i>
                                    从素材库中选择
                                </a>
                                <!-- <div class="con-appmsg pull-left" v-for="appmsg in rsp.value">
                                    <a>
                                        <span class="bg" :style="{backgroundImage: 'url('+ appmsg.cover +')'}"></span>
                                        <span class="title pull-left">
                                        [图文消息]{{appmsg.title}}</span>
                                        <p class="desc">{{appmsg.content}}</p>
                                        <div class="clearfix"></div>
                                    </a>
                                </div> -->
                                <div class="pull-right text-right opr">
                                    <a class="delete" @click="deleteResponse(form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div>   
                                <div class="clearfix"></div>                         
                            </div>
                        </template>
                    </div>             
                </div>
                <div class="edit-bottom">
                    <div class="pull-left statics">
                       {{form.response | responseCount(1)}}
                    </div>
                    <div class="pull-right opr text-right">
                        <el-button class="btn-green" @click="save(-1)">保存</el-button>
                        <el-button @click="clearForm">删除</el-button>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="show-item" v-else>
                <div class="item-list">
                    <div class="pull-left rule-name">关键词</div>
                    <div class="pull-left kw-list">
                        <span v-for="kw in form.keyword">{{kw.keyword}}</span>
                    </div>
                </div>
                <div class="item-list">
                    <div class="pull-left rule-name">回复</div>
                    <div class="pull-left">
                        {{form.response.length}}条（{{form.response | responseCount}}）
                    </div>
                    <div class="clearfix"></div>
                    <p v-if="form.response.length > 0">发送全部回复</p>
                </div>
            </div>
        </div>
        <div class="rule-item mt20" v-for="(list, i) in lists" >
            <div class="rule-item-top">
                规则{{i+1}}:{{list.rule_title}}
                <a class="pull-right" @click="list.editing = !list.editing"><i class="icon ion-arrow-down-b"></i></a>
            </div>
            <div class="edit-item" v-if="list.editing && list.form">
                <div class="item rule-name-area">
                    <label class="rule-label rule-name">规则名</label>
                    <el-input v-model="list.form.rule_title"></el-input>
                    <p class="edit-tips">规则名最多60个字</p>
                </div>
                <div class="item">
                    <label class="rule-label rule-kw">关键字</label>
                    <a class="pull-right add-kw" @click="openKwDlg(i)">添加关键字</a>
                    <div class="kw-list">
                        <div class="kw-item" v-if="list.form" v-for="(kw, k) in list.form.keyword">
                            <span>{{kw.keyword}}</span>
                            <div class="pull-right text-right opr">
                                <a>已全匹配</a>
                                <a class="edit" @click="openKwDlg(i, k)"><i class="icon ion-android-create"></i></a>
                                <a class="delete" @click="deleteKeyword(list.form.keyword, k)"><i class="icon ion-ios-trash"></i></a>
                            </div>                            
                        </div>
                    </div>
                </div>
                <div class="item">
                    <label class="rule-label rule-reply">回复</label>
                    <div class="pull-right text-right opr">
                        <el-checkbox :checked="true" :disabled="true">回复全部</el-checkbox>
                    </div>                    
                </div>
                <div class="item">
                    <ul class="toolbar">                        
                        <li @click="openTextDlg(i)"><i class="menu-con text"></i></li>
                        <li @click="photo_idx=i;dlgPhotoVisible=true;"><i class="menu-con img"></i></li>
                        <li><i class="menu-con voice"></i></li>
                        <li><i class="menu-con video"></i></li>
                        <li @click="material_idx=i;dlgMaterialVisible=true;"><i class="menu-con appmsg"></i></li>
                    </ul> 
                    <div class="edit-content">
                        <template v-if="list.form" v-for="(rsp, r) in list.form.response">
                            <div class="con-item" v-if="rsp.type == 1">
                                <span>{{rsp.text}}</span>
                                <div class="pull-right text-right opr">
                                    <a class="edit" @click="openTextDlg(i, r)"><i class="icon ion-android-create"></i></a>
                                    <a class="delete" @click="deleteResponse(list.form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div> 
                            </div>
                            <div class="con-item" v-else-if="rsp.type == 2">
                                <div class="con-appmsg pull-left">
                                    <a>
                                        <span class="bg" :style="{backgroundImage: 'url('+ rsp.img_url +')'}"></span>
                                        <span class="title pull-left">
                                        [图片]</span>
                                        <div class="clearfix"></div>
                                    </a>
                                </div>
                                <div class="pull-right text-right opr">
                                    <a class="delete" @click="deleteResponse(list.form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div>   
                                <div class="clearfix"></div> 
                            </div>
                            <div class="con-item" v-else-if="rsp.type == 3">
                                <div v-show="rsp.value.length > 0" 
                                     v-for="(appmsg, v) in rsp.value"
                                    class="news-item" :style="{backgroundImage: 'url('+ appmsg.cover +')'}">
                                    <span>{{appmsg.title}}</span>
                                    <div class="cover-del" @click="deleteMaterial(rsp.value, v)"><i class="icon ion-ios-trash"></i></div>
                                </div>
                                <a class="select-outer" @click="material_idx=i;dlgMaterialVisible=true;material_rsp_idx=r;" v-show="rsp.value.length < 8">
                                    <i class="icon ion-ios-plus-empty"></i>
                                    从素材库中选择
                                </a>
                                <!-- <div class="con-appmsg pull-left" v-for="appmsg in rsp.value">
                                    <a>
                                        <span class="bg" :style="{backgroundImage: 'url('+ appmsg.cover +')'}"></span>
                                        <span class="title pull-left">
                                        [图文消息]{{appmsg.title}}</span>
                                        <p class="desc">{{appmsg.content}}</p>
                                        <div class="clearfix"></div>
                                    </a>
                                </div> -->
                                <div class="pull-right text-right opr">
                                    <a class="delete" @click="deleteResponse(list.form.response, r)"><i class="icon ion-ios-trash"></i></a>
                                </div>   
                                <div class="clearfix"></div>
                            </div>
                        </template>
                    </div>                
                </div>
                <div class="edit-bottom">
                    <div class="pull-left statics">
                       <!-- 文字(2)、 图片(0)、 语音(0)、 视频(0)、 图文(1)  -->
                       {{list.form.response | responseCount(1)}}
                    </div>
                    <div class="pull-right opr text-right">
                        <el-button class="btn-green" @click="save(i)">保存</el-button>
                        <el-button @click="deleteRule(i)">删除</el-button>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="show-item" v-else>
                <div class="item-list">
                    <div class="pull-left rule-name">关键词</div>
                    <div class="pull-left kw-list">
                        <span v-for="kw in list.keyword">{{kw.keyword}}</span>
                    </div>
                </div>
                <div class="item-list">
                    <div class="pull-left rule-name">回复</div>
                    <div class="pull-left">
                        {{list.response.length}}条（{{list.response | responseCount}}）
                    </div>
                    <div class="clearfix"></div>
                    <p v-if="list.response.length > 0">发送全部回复</p>
                </div>
            </div>
        </div>
        <div class="mt30"  v-if="lists.length == 0">
            暂无内容
        </div>

        <el-dialog
            :title="keywordTitle"
            custom-class="keyword-edit-dlg"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            :before-close="closeDlg"
            :visible.sync="dlgVisible">
            <div class="dlg-body">
                <textarea @keyup.13="addKeyword" v-model.trim="editKeyword"></textarea>
                <p class="kw-tips">输入回车可添加多个关键字，每个关键字少于30个字符</p>
                <div class="kw-list">
                    <a v-for="(kw, k) in addKeywords" @click="deleteDialogKw(k)">{{kw}}<i>&times</i></a>
                </div>
            </div>
            <div slot="footer" class="dialog-footer text-center">
                <el-button class="mr30" @click="subKeyword">确定</el-button>
                <el-button class="mr30" @click="closeDlg">取消</el-button>
            </div>
        </el-dialog>

        <el-dialog
            :title="TextTitle"
            custom-class="text-edit-dlg"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            :before-close="closeTextDlg"
            :visible.sync="dlgTextVisible">
            <div class="dlg-body">
                <div contenteditable="true" id="textcon" class="textarea" tabindex="101" @blur="blurText"></div>
                <p class="kw-tips">限制300字</p>
            </div>
            <div slot="footer" class="dialog-footer text-center">
                <el-button class="mr30" @click="subText">确定</el-button>
                <el-button class="mr30" @click="closeTextDlg">取消</el-button>
            </div>
        </el-dialog>
        <material-select-dialog
            @closeDlg="closeMaterialDlg"
            :title="'选择图文'"
            :dialogVisible="dlgMaterialVisible">
        </material-select-dialog>
        <photo-select-dialog 
            @closeDlg="closePhotoDlg"
            :title="'选择图片'"
            :dialogVisible="dlgPhotoVisible">
            </photo-select-dialog>
    </div>
</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";
    @import "../../../assets/sass/common/wechat_btn";
    [i="wechat-autoreply-keywords"]{
        width: 927px;
        .add{

        }
        .rule-item{
            border: 1px solid #e7e7eb;
            .rule-item-top{
                padding: 0 14px;
                background-color: #f4f5f9;
                border-bottom: 1px solid #e7e7eb;
                line-height: 40px;
                a{
                    color: #c6c6c6;
                    &.active{
                        animation: arrow .5s;
                    }
                }
                @keyframes arrow{
                    from{
                        transform: rotate(0deg);
                    } 
                    to{
                        transform: rotate(180deg);
                    }
                }

            }
            .edit-item{
                .item{
                    line-height: 39px;
                    border-bottom: 1px solid #e7e7eb;
                    .rule-label{
                        margin-left: 14px;
                        padding-left: 14px;
                        background: transparent url(../../../assets/icon_point.png) no-repeat 0 50%;
                        width: 80px;
                        display: inline-block;
                    }
                    .edit-tips{
                        color: #8d8d8d;
                        padding-left: 94px;
                    }
                    .add-kw{
                        margin-right: 14px;
                    }
                    .kw-list{
                        padding-left: 28px;
                        border-top: 1px solid #e7e7eb;
                        .kw-item{
                            line-height: 56px;
                            height: 56px;
                            border-bottom: 1px solid #e7e7eb;
                            clear: both;
                            &:last-child{
                                border-bottom:none;
                            }
                        }
                    }
                    .opr{
                        margin-right: 14px;
                        i{
                            width: 25px;
                            display: inline-block;
                            line-height: 56px;
                        }
                        .edit{
                            font-size: 18px;
                            color: #8d8d8d;
                        }
                        .delete{
                            font-size: 18px;
                            color: #8d8d8d;
                        }
                    }

                    ul.toolbar{
                        border-bottom: 1px solid #e7e7eb;
                        height: 100%;
                        overflow: auto;
                        padding-left: 30px;
                        li{
                            height: 39px;
                            line-height: 39px;
                            float: left;
                            position: relative;
                            cursor: pointer;
                            color: #8d8d8d;
                            margin-right: 30px;
                            i.icon{
                                font-size: 20px;
                                vertical-align: middle;
                                color: #8d8d8d;
                                padding-right: 5px;
                            }
                            i.menu-con{
                                vertical-align: top;
                                background: url(../../../assets/msg_tab.png) 0 0 no-repeat;
                                display: inline-block;
                                margin-right: 3px;
                                width: 20px;
                                height: 30px;

                                &.text{
                                    background-position-y: 9px;
                                }
                                &.appmsg{
                                    background-position-y: -231px;
                                }
                                &.img{
                                    background-position-y: -51px;
                                }
                                &.voice{
                                    background-position-y: -171px;
                                }
                                &.video{
                                    background-position-y: -111px;
                                }
                            }
                            &.active{
                                color: #222;
                                .text{
                                    background-position-y: -21px!important;
                                }
                                .appmsg{
                                    background-position-y: -261px!important;
                                }
                                .img{
                                    background-position-y: -81px!important;
                                }
                                .voice{
                                    background-position-y: -201px!important;
                                }
                                .video{
                                    background-position-y: -141px;
                                }
                                i.icon{
                                    color: #222;
                                }

                            }
                            &:hover i{
                                &.icon{
                                    color: #222;
                                }
                                &.text{
                                    background-position-y: -21px!important;
                                }
                                &.appmsg{
                                    background-position-y: -261px!important;
                                }
                                &.img{
                                    background-position-y: -81px!important;
                                }
                                &.voice{
                                    background-position-y: -201px;
                                }
                                &.video{
                                    background-position-y: -141px;
                                }
                            }
                        }
                    }
                    .edit-content{
                        .con-item{
                            margin-left: 28px;
                            border-bottom: 1px solid #e7e7eb;
                            position: relative;
                            &>span{
                                padding: 15px 0;
                                line-height: normal;
                                min-height: 56px;
                                height: 56px;
                                display: inline-block;
                            }
                            .opr{
                                min-height: 56px;
                                height: 56px;
                                position: absolute;
                                right: 0;
                                top: 0;
                            }

                            .news-item{
                                width: 165px;    
                                height: 140px;
                                background-repeat: no-repeat;
                                background-position: center center;
                                background-size: cover;
                                position: relative;
                                margin-left: 20px;
                                margin-top: 10px;
                                background-color: #ececec;
                                float:left;
                                margin-bottom: 10px;
                                span{
                                    width: 100%;
                                    height: 28px;
                                    line-height: 28px;
                                    color: #fff;
                                    position: absolute;
                                    bottom: 0;
                                    padding: 0 10px;
                                    display: inline-block;
                                    @include wordEllipsis();
                                    background-color: rgba(0,0,0,.5);
                                }
                                .cover-del{
                                    width: 100%;
                                    height: 100%;
                                    position: absolute;
                                    display: none;  
                                    line-height: 145px;
                                    text-align: center;
                                    color: #fff;
                                    font-size: 64px;
                                    cursor: pointer;
                                }
                                &:hover .cover-del{
                                    display: block;
                                    background-color: rgba(0, 0, 0, .5);
                                }
                            }

                            .select-outer{
                                margin-bottom: 10px;
                                color: #8d8d8d;
                                width: 165px;
                                height: 140px;
                                border: 2px dotted #e7e7eb;
                                display: inline-block;
                                font-size: 14px;
                                text-align: center;
                                padding-top: 10px;
                                margin-top: 10px;
                                margin-left: 20px;
                                i{
                                    font-size: 64px;
                                    display: block;
                                }
                                &:first-child{
                                    margin-right: 30px;
                                }
                            }
                            .con-appmsg{  
                                padding: 15px 0; 
                                padding-left: 90px;
                                position: relative;
                                min-height: 110px;    
                                clear: left;
                                .bg{
                                    position: absolute;
                                    left:0;
                                    width: 80px;
                                    height: 80px;
                                    background: no-repeat center center/cover;
                                }
                                .title{
                                    color: #222;
                                    display: inline-block;
                                    word-break: break-all;
                                    max-width: 400px;
                                    line-height: 20px;
                                    @include wordEllipsis();
                                    clear: right;
                                    &:hover{
                                        text-decoration: underline;
                                    }
                                }
                                .desc{
                                    color: #666;
                                    padding: 15px 0; 
                                    clear: both;
                                    max-width: 400px;
                                    line-height: 20px;
                                    &:hover{
                                        text-decoration: underline;
                                    }
                                }
                            }
                            &:last-child{
                                border-bottom: none;
                            }
                        }
                    }

                    &.rule-name-area{
                        padding: 14px 0;
                        .el-input{
                            width: 300px;
                        }
                    }
                }
                .edit-bottom{
                    padding: 0 14px;
                    height: 50;
                    line-height: 50px;
                    background-color: #f4f5f9;
                    .statics{
                        color: #8d8d8d;
                    }
                    .opr{
                    }
                }
            }
            .show-item{    
                padding: 14px;
                .item-list{
                    clear: both;
                    line-height: 28px;
                    padding: 5px 0;
                    .rule-name{width: 75px;}
                    .kw-list{
                        width: 750px;
                        span{
                            background-color: #e5e7ec;
                            padding: 0 10px;
                            height: 20px;
                            line-height: 20px;
                            display: inline-block;
                            margin-right: 10px;
                            margin-bottom: 10px;
                        }
                    }
                    p{
                        clear: both;
                    }
                }
            }
        }


        .keyword-edit-dlg{
            &.el-dialog{
            }
            .el-dialog__header{
                border-bottom: 1px solid #e7e7eb;
                height: 52px;
                background-color: rgb(244, 245, 249);
                .el-dialog__title{
                    font-weight: normal;
                }
            }
            .el-dialog__body{
                padding: 20px;
            }
            .el-dialog__footer{
                padding: 0;
                border-top: 1px solid #e7e7eb;
                text-align: left;
            }

            .dlg-body{
                height: 500px;
                textarea{
                    outline: 0;
                    padding: 10px;
                    width: 100%;
                    height: 100px;
                    resize: none;
                }
                .kw-tips{
                    color: #8d8d8d;
                    padding: 5px 0 20px;
                }
                .kw-list{
                    width: 100%;
                    height: 200px;
                    overflow-y: auto;
                    a{
                        color: #222;
                        display: inline-block;
                        vertical-align: top;
                        line-height: 24px;
                        height: 24px;
                        margin-bottom: 10px;
                        margin-right: 10px;
                        background-color: #e5e7ec;
                        padding: 0 7px;
                        i{
                            color: #8d8d8d;
                            margin-left: 10px
                        }
                        &:hover{
                            color: #fff;
                            background-color: rgb(121,121,121);
                            i{
                                color: #fff;
                            }
                        }
                    }
                }
            }
            .dialog-footer{
                padding: 0;
                line-height: 65px;
                background-color: #f4f5f9;
            }
        }
        .text-edit-dlg{
            &.el-dialog{
            }
            .el-dialog__header{
                border-bottom: 1px solid #e7e7eb;
                height: 52px;
                background-color: rgb(244, 245, 249);
                .el-dialog__title{
                    font-weight: normal;
                }
            }
            .el-dialog__body{
                padding: 20px;
            }
            .el-dialog__footer{
                padding: 0;
                border-top: 1px solid #e7e7eb;
                text-align: left;
            }

            .dlg-body{
                height: 500px;
                .textarea{
                    outline: 0;
                    padding: 10px;
                    width: 100%;
                    height: 300px;
                    resize: none;
                    border: 1px solid #e7e7eb;
                }
                .kw-tips{
                    color: #8d8d8d;
                    padding: 5px 0 20px;
                }
            }
            .dialog-footer{
                padding: 0;
                line-height: 65px;
                background-color: #f4f5f9;
            }
        }
    }
</style>
<script>
    import materialSelectDialog from '../Materialselectdialog.vue';
    import photoSelectDialog from '../Photoselectdialog.vue';
    import {Button,Checkbox} from 'element-ui';
    tools.vue.use(Button);
    tools.vue.use(Checkbox);
    
    export default{
        data(){
            return {
                //关键字弹窗
                dlgVisible: false,
                keywordTitle: '添加关键字',
                addKeywords:[],
                editKeyword: '',
                kw_idx: -1,//-1为新规则的
                edit_idx: undefined,//存在则为修改关键字， 对应keyword的idx
                //修改回复文字弹窗
                dlgTextVisible: false,
                TextTitle: '添加回复文字',
                editText: '',
                text_idx: -1,//-1为新规则的
                rsp_text_idx: undefined,//存在则为修改关键字， 对应response的idx
                //图文弹窗
                dlgMaterialVisible: false,
                material_idx: -1,//-1为新规则的
                material_rsp_idx: undefined,//存在则为追加图文， 对应response的idx，否则为新加的图文
                //图片弹窗
                dlgPhotoVisible: false,
                photo_idx: -1,//-1为新规则的


                //新规则的数据
                form:{
                    editing: false,
                    rule_title: '',
                    keyword: [],
                    response: []
                },
                lists: [
                    /*{
                        id: 0,
                        rule_title: '',
                        response: [],
                        keyword: [],
                        text_num: 0,
                        photo_num: 0,
                        appmsg_num: 0,
                    }*/
                ],
                is_new: false,
            }
        },
        computed:{

        },
        methods: {
            getData: function(){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/keyword',
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            for(let i in res.list){
                                let appmsg_num = 0,
                                    text_num = 0,
                                    photo_num = 0;
                                for(let j in res.list[i].response){
                                    if(res.list[i].response[j].type == 1){
                                        appmsg_num++;
                                    }
                                    else if(res.list[i].response[j].type == 2){
                                        text_num++;
                                    }
                                    else if(res.list[i].response[j].type == 3){
                                        photo_num++;
                                    }
                                }
                                res.list[i].appmsg_num = appmsg_num;
                                res.list[i].text_num = text_num;
                                res.list[i].photo_num = photo_num;
                                res.list[i].form = Object.assign({}, res.list[i]);
                                res.list[i].editing = false;
                            }
                            that.lists = res.list;
                        }

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });

            },
            save: function(idx){
                let that = this, ajaxData = {}, tmpData = {};
                if(idx < 0){
                    if(that.form.rule_title == ''){
                        tools.alert.message('请输入规则名');
                        return false;
                    }
                    ajaxData.rule_title = that.form.rule_title;
                    if(that.form.keyword.length > 0){
                        ajaxData.keyword = [];
                        for(let i in that.form.keyword){
                            ajaxData.keyword.push({
                                key: that.form.keyword[i].keyword,
                                is_matching: 1
                            });
                        }
                    }
                    if(that.form.response.length <= 0){
                        tools.alert.message('请填写回复内容');
                        return false;
                    }
                    else{
                        ajaxData.response = [];
                        for(let i in that.form.response){
                            let tmpObj = {};
                            tmpObj.type = that.form.response[i].type;
                            switch(tmpObj.type){
                                case 1:{
                                    tmpObj.response = that.form.response[i].text;
                                };break;
                                case 2:{
                                    tmpObj.response = that.form.response[i].wechat_image_media_id;
                                };break;
                                case 3:{
                                    tmpObj.response = [];
                                    for(let j in that.form.response[i].value){
                                        tmpObj.response.push(that.form.response[i].value[j].news_id);
                                    }
                                };break;
                            }
                            ajaxData.response.push(tmpObj);
                        }
                    }
                }
                else{
                    if(that.lists[idx].form.rule_title == ''){
                        tools.alert.message('请输入规则名');
                        return false;
                    }
                    ajaxData.rule_title = that.lists[idx].form.rule_title;
                    if(that.lists[idx].form.keyword.length > 0){
                        ajaxData.keyword = [];
                        for(let i in that.lists[idx].form.keyword){
                            ajaxData.keyword.push({
                                key: that.lists[idx].form.keyword[i].keyword,
                                is_matching: 1
                            });
                        }
                    }
                    if(that.lists[idx].form.response.length > 0){
                        ajaxData.response = [];
                        for(let i in that.lists[idx].form.response){
                            let tmpObj = {};
                            tmpObj.type = that.lists[idx].form.response[i].type;
                            switch(tmpObj.type){
                                case 1:{
                                    tmpObj.response = that.lists[idx].form.response[i].text;
                                };break;
                                case 2:{
                                    tmpObj.response = that.lists[idx].form.response[i].wechat_image_media_id;
                                };break;
                                case 3:{
                                    tmpObj.response = [];
                                    for(let j in that.lists[idx].form.response[i].value){
                                        tmpObj.response.push(that.lists[idx].form.response[i].value[j].news_id);
                                    }
                                };break;
                            }
                            ajaxData.response.push(tmpObj);
                        }
                    }
                }
                //console.log(ajaxData);
                //return false;
                //console.log(JSON.stringify(ajaxData));
                let url='/api/admin/wechat/keyword', method = 'POST';
                if(idx >= 0){
                    url='/api/admin/wechat/keyword/' + that.lists[idx].id;
                    method = 'PUT';
                }

                tools.alert.loading();
                tools.ajax({
                    url: url,
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            that.clearForm();
                            that.getData();
                        }

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: method
                });
            },
            deleteRule: function(idx){
                let that = this;
                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/keyword/'+ that.lists[idx].id,
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            that.clearForm();
                            that.getData();
                        }

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'DELETE'
                });

            },
            deleteKeyword: function(keywordArr, idx){
                keywordArr.splice(idx, 1);
            },
            deleteResponse: function(responseArr, idx){
                responseArr.splice(idx, 1);
            },
            //kw_idx 对应list的idx，新规则为-1
            //edit_idx 存在则为修改关键字， 对应keyword的idx，新规则为-1
            openKwDlg: function(kw_idx, edit_idx){
                let that = this;
                that.kw_idx = kw_idx;
                that.edit_idx = edit_idx;
                that.keywordTitle = '添加关键字';
                if(edit_idx !== undefined){//修改
                    that.keywordTitle = '修改关键字';
                    if(kw_idx < 0){
                        that.editKeyword = that.form.keyword[edit_idx].keyword;
                    }
                    else{
                        that.editKeyword = that.lists[kw_idx].form.keyword[edit_idx].keyword;
                    }
                }
                that.dlgVisible = true;
            },
            deleteDialogKw: function(idx){
                let that = this;
                that.addKeywords.splice(idx, 1);
            },
            closeDlg: function(){
                let that = this;                
                that.editKeyword = '';
                that.addKeywords = null;
                that.addKeywords = [];
                that.edit_idx = undefined;
                
                that.dlgVisible = false;
            },
            addKeyword: function(){
                let that = this;
                if(that.edit_idx !== undefined){
                    return false;
                }
                if(that.editKeyword != ''){
                    that.addKeywords.push(that.editKeyword.replace(/\n/g,' '));
                    that.editKeyword = '';
                }
            },
            subKeyword: function(){
                let that = this;
                //debugger
                that.editKeyword = that.editKeyword.replace(/\n/g, ' ');
                if(that.edit_idx !== undefined){//修改
                    if(that.kw_idx < 0){
                        that.form.keyword[that.edit_idx].keyword = that.editKeyword;
                        console.log(that.form);
                    }
                    else{
                        that.lists[that.kw_idx].form.keyword[that.edit_idx].keyword = that.editKeyword;
                        console.log(that.lists[that.kw_idx].form);
                    }
                }
                else{
                    if(that.kw_idx < 0){
                        for(let i in that.addKeywords){
                            that.form.keyword.push({
                                keyword: that.addKeywords[i],
                                is_matching: 0
                            })
                        }
                        console.log(that.form);
                    }
                    else{
                        for(let i in that.addKeywords){
                            that.lists[that.kw_idx].form.keyword.push({
                                keyword: that.addKeywords[i],
                                is_matching: 0
                            })
                        }
                        console.log(that.lists[that.kw_idx].form);
                    }                    
                }
                that.editKeyword = '';
                that.addKeywords = null;
                that.addKeywords = [];
                that.edit_idx = undefined;
                
                that.dlgVisible = false;

            },
            //text_idx 对应list的idx，新规则为-1
            //rsp_text_idx 存在则为修改关键字， 对应response的idx
            openTextDlg: function(text_idx, rsp_text_idx){
                let that = this;
                $('#textcon').empty();
                that.dlgTextVisible = true;
                that.rsp_text_idx = rsp_text_idx;
                that.text_idx = text_idx;
                that.TextTitle = '添加回复文字';
                if(rsp_text_idx !== undefined){//修改
                    that.TextTitle = '修改回复文字';
                    if(text_idx < 0){
                        that.editText = that.form.response[rsp_text_idx].text;
                    }
                    else{
                        that.editText = that.lists[text_idx].form.response[rsp_text_idx].text;
                    }
                    setTimeout(function(){
                        $('#textcon').html(that.editText);
                    },0);
                }
            },
            closeTextDlg: function(){
                let that = this;                
                that.editText = '';
                that.rsp_text_idx = undefined;
                
                that.dlgTextVisible = false;                
            },
            blurText: function(){
                let that = this;
                that.editText = $('#textcon').html();
            },
            subText: function(){
                let that = this;
                //debugger
                if(that.rsp_text_idx !== undefined){//修改
                    if(that.text_idx < 0){
                        that.form.response[that.rsp_text_idx].text = that.editText;
                        console.log(that.form);
                    }
                    else{
                        that.lists[that.text_idx].form.response[that.rsp_text_idx].text = that.editText;
                        console.log(that.lists[that.text_idx].form);
                    }
                }
                else{
                    if(that.text_idx < 0){
                        that.form.response.push({
                            type: 1,
                            text: that.editText
                        });
                        console.log(that.form);
                    }
                    else{
                        that.lists[that.text_idx].form.response.push({
                            type: 1,
                            text: that.editText
                        });
                        console.log(that.lists[that.text_idx].form);
                    }                    
                }
                that.editText = '';
                $('#textcon').empty();
                that.rsp_text_idx = undefined;
                
                that.dlgTextVisible = false;

            },
            openMaterialDlg: function(material_idx){
                let that = this;
            },
            closeMaterialDlg: function(obj){
                let that = this;
                if(obj){
                    if(that.material_rsp_idx !== undefined){//追加图文
                        if(that.material_idx < 0){
                            that.form.response[that.material_rsp_idx].value.push({
                                    news_id: obj.img_arr[0].id,
                                    cover: obj.img_arr[0].cover,
                                    title: obj.img_arr[0].title,
                                    url: obj.img_arr[0].url
                                });
                            console.log(that.form);
                        }
                        else{
                            that.lists[that.material_idx].form.response[that.material_rsp_idx].value.push({
                                    news_id: obj.img_arr[0].id,
                                    cover: obj.img_arr[0].cover,
                                    title: obj.img_arr[0].title,
                                    url: obj.img_arr[0].url
                                });
                            console.log(that.lists[that.material_idx].form);
                        }
                    }
                    else{
                        if(that.material_idx < 0){
                            that.form.response.push({
                                type: 3,
                                value: [{
                                    news_id: obj.img_arr[0].id,
                                    cover: obj.img_arr[0].cover,
                                    title: obj.img_arr[0].title,
                                    url: obj.img_arr[0].url
                                }]
                            });
                            console.log(that.form);
                        }
                        else{
                            that.lists[that.material_idx].form.response.push({
                                type: 3,
                                value: [{
                                    news_id: obj.img_arr[0].id,
                                    cover: obj.img_arr[0].cover,
                                    title: obj.img_arr[0].title,
                                    url: obj.img_arr[0].url
                                }]
                            });
                            console.log(that.lists[that.material_idx].form);
                        }                    
                    }

                }
                that.material_rsp_idx = undefined;
                that.dlgMaterialVisible = false;
            },
            deleteMaterial: function(rsp_value, rsp_idx){
                let that = this;
                rsp_value.splice(rsp_idx, 1);
            },
            closePhotoDlg: function(obj){
                let that = this;
                if(obj){
                    if(that.photo_idx < 0){
                        that.form.response.push({
                            type: 2,
                            img_url: obj.img_arr[0].path,
                            wechat_image_media_id: obj.img_arr[0].id
                        });
                    }
                    else{
                        that.lists[that.photo_idx].form.response.push({
                            type: 2,
                            img_url: obj.img_arr[0].path,
                            wechat_image_media_id: obj.img_arr[0].id
                        });
                    }    
                }
                that.dlgPhotoVisible = false;
            },
            clearForm: function(){
                let that = this;
                that.is_new = false;
                that.form = null;
                that.form = {
                    editing: false,
                    rule_title: '',
                    keyword: [],
                    response: []
                };

            }
        },
        components: {
            photoSelectDialog,
            materialSelectDialog
        },
        filters:{
            //type 显示形式
            //1: 文字(1)、 图片(2)、 语音(0)、 视频(0)、 图文(1)
            //2: 1条文字，2条图片，0条语音，0条视频，1条图文
            responseCount: function(response, type){
                let appmsg_num = 0,
                    text_num = 0,
                    photo_num = 0;
                for(let j in response){
                    if(response[j].type == 1){
                        text_num++;
                    }
                    else if(response[j].type == 2){
                        photo_num++;
                    }
                    else if(response[j].type == 3){
                        appmsg_num++;
                    }
                }
                if(type === 1){
                    return '文字('+ text_num +')、 图片('+ photo_num +')、 语音(0)、 视频(0)、 图文('+ appmsg_num +') ';
                }
                return text_num +'条文字，'+ photo_num +'条图片，0条语音，0条视频，'+ appmsg_num +'条图文';
            },

        },
        watch:{

        },
        mounted(){
            let that = this;
            that.getData();

        }
    }
</script>
